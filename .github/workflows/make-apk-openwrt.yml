name: Build luci-theme-alpha at specific OpenWrt commit SHA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Clone luci-theme-alpha (branch Alpha-OS-4.0-Beta-(for-OpenWrt-24.xx))
        run: |
          git clone -b "Alpha-OS-4.0-Beta-(for-OpenWrt-24.xx)" https://github.com/derisamedia/luci-theme-alpha.git luci-theme-alpha

      - name: Clone OpenWrt source at specific commit
        run: |
          git clone https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          git checkout d872d00b2f7e31b98e11e83922d1aaefc270647e

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Copy luci-theme-alpha
        run: |
          mkdir -p openwrt/package/custom/
          cp -r ../luci-theme-alpha openwrt/package/custom/

      - name: Enable APK in config
        run: |
          cd openwrt
          echo "CONFIG_PACKAGE_MANAGER_APK=y" >> .config
          make defconfig

      - name: Build luci-theme-alpha
        run: |
          cd openwrt
          make package/custom/luci-theme-alpha/compile V=s

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-theme-alpha-apk
          path: openwrt/bin/packages/**/*.apk
